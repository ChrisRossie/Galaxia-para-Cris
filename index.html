<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>Galaxia para Cris</title>
  <meta name="description" content="Galaxia interactiva de frases de cari√±o üíï">
  <meta property="og:title" content="Galaxia para Cris">
  <meta property="og:description" content="Una galaxia interactiva con palabras de cari√±o üíñ">
  <meta property="og:image" content="og-cover.png">
  <link rel="icon" type="image/png" href="favicon.png">
  <style>
    html,body{margin:0;height:100%;background:#000;overflow:hidden;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial}
    
    /* Welcome Screen */
    #welcome-screen{position:fixed;inset:0;background:linear-gradient(135deg,#1a0014,#30002a);display:flex;flex-direction:column;justify-content:center;align-items:center;z-index:1000;color:white;padding:20px;text-align:center;}
    .welcome-content{max-width:600px;background:rgba(255,255,255,0.1);backdrop-filter:blur(10px);padding:40px;border-radius:20px;border:1px solid rgba(255,255,255,0.2);}
    .welcome-title{font-size:2.5em;margin-bottom:20px;background:linear-gradient(45deg,#ff6b9d,#ff93ac,#ffb6c1,#ffd1dc);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
    .welcome-message{font-size:1.2em;line-height:1.6;margin-bottom:30px;color:#ffe6f2;}
    #enter-btn{padding:15px 40px;font-size:1.3em;background:linear-gradient(45deg,#ff6b9d,#ff93ac);border:none;border-radius:50px;color:white;cursor:pointer;transition:transform 0.3s;font-weight:bold;}
    #enter-btn:hover{transform:scale(1.1);}
    
    /* Warp Effect */
    #warp-effect{position:fixed;inset:0;background:#000;z-index:999;display:none;}
    .warp-line{position:absolute;height:2px;background:linear-gradient(90deg,transparent,#ff93ac,transparent);width:100%;}
    
    /* Galaxy */
    #galaxy-canvas{position:fixed;inset:0;width:100%;height:100%;display:block;touch-action:none;display:none;}
    .pill{position:fixed;top:10px;left:50%;transform:translateX(-50%);padding:6px 12px;border-radius:999px;
          background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.18);color:#fff;font:12px -apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial;display:none;}
    .error{position:fixed;inset:auto 10px 70px 10px;background:#260015;color:#ffd9f7;border:1px solid #ff8ae5;border-radius:10px;padding:10px;font:12px system-ui;display:none;}
    
    /* Narrative Text */
    #narrative-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 900;
      pointer-events: none;
    }
    
    .narrative-text {
      color: white;
      font-size: 1.4em;
      text-align: center;
      max-width: 80%;
      background: rgba(0, 0, 0, 0.7);
      padding: 30px;
      border-radius: 15px;
      border: 1px solid rgba(255, 182, 193, 0.3);
      backdrop-filter: blur(10px);
      line-height: 1.6;
      opacity: 0;
      transform: translateY(20px);
      transition: opacity 0.8s ease, transform 0.8s ease;
    }
    
    .narrative-text.visible {
      opacity: 1;
      transform: translateY(0);
    }
    
    .narrative-text.final {
      font-size: 2em;
      color: #ffb6c1;
      background: rgba(0, 0, 0, 0.8);
    }
  </style>
  <!-- Three.js legacy non-module build + OrbitControls (r128, super estable) -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
</head>
<body>
<!-- Welcome Screen -->
<div id="welcome-screen">
  <div class="welcome-content">
    <h1 class="welcome-title">‚ú® Hola, mi amor Cris ‚ú®</h1>
    <p class="welcome-message">
      Esta es tu galaxia, ven ac√° cada que quieras sentirte amada.<br>
      Recuerda que te amo mil millones.<br><br>
      - Para ti, mi vida
    </p>
    <button id="enter-btn">üöÄ Viajar a tu galaxia</button>
  </div>
</div>

<!-- Warp Effect -->
<div id="warp-effect"></div>

<!-- Narrative Text Container -->
<div id="narrative-container">
  <div class="narrative-text" id="current-narrative"></div>
</div>

<!-- Galaxy -->
<canvas id="galaxy-canvas"></canvas>
<div class="pill">Te Amo Muchote Mi Amor Cris üíï</div>
<div id="err" class="error"></div>

<canvas id="fx" style="position:fixed;inset:0;pointer-events:none;display:none;"></canvas>

<audio id="background-music" loop>
  <source src="cancion.mp3" type="audio/mpeg">
  Tu navegador no soporta el elemento de audio.
</audio>
<script>
(function(){
// ====== WELCOME SCREEN & WARP EFFECT ======
const welcomeScreen = document.getElementById('welcome-screen');
const warpEffect = document.getElementById('warp-effect');
const galaxyCanvas = document.getElementById('galaxy-canvas');
const fxCanvas = document.getElementById('fx');
const pill = document.querySelector('.pill');
const backgroundMusic = document.getElementById('background-music');
const enterBtn = document.getElementById('enter-btn');
const narrativeContainer = document.getElementById('narrative-container');
const currentNarrative = document.getElementById('current-narrative');

// Sistema de sincronizaci√≥n manual como subt√≠tulos
// Tiempos exactos en segundos para cada texto (basado en el tiempo de la canci√≥n)
const narrativeTimeline = [
  { start: 0, end: 5, text: "Cris,<br>he cruzado regiones donde la luz tarda siglos en admitir que existi√≥,<br>y aun as√≠ ninguna estrella sabe pronunciar tu nombre como lo hace mi memoria." },
  { start: 5, end: 10, text: "Voy flotando entre c√∫mulos y nebulosas,<br>preguntando al polvo antiguo d√≥nde encaja una mujer<br>que naci√≥ con el brillo suficiente para avergonzar a las constelaciones." },
  { start: 10, end: 15, text: "Hay noches en que el espacio es silencio puro,<br>pero incluso ah√≠ encuentro rastros tuyos:<br>una vibraci√≥n leve, una curvatura m√≠nima de luz,<br>como si el universo se hubiera aprendido tu gesto de mirar hacia otro lado." },
  { start: 15, end: 20, text: "Y sigo.<br>A veces me pregunto si busco un sitio para ti<br>o si simplemente estoy siguiendo el camino que deja tu propia gravedad." },
  { start: 20, end: 25, text: "Porque cada vez que una estrella colapsa,<br>hay un destello que dura menos que un parpadeo,<br>y aun as√≠ pienso: 'ella merecer√≠a uno m√°s largo, uno s√≥lo suyo'." },
  { start: 25, end: 30, text: "Cris,<br>cuando por fin halle un rinc√≥n del cosmos que no te quede peque√±o,<br>cuando encuentre un cielo que no tema compararse<br>con la forma en que t√∫ enciendes el m√≠o,<br>te lo se√±alar√© sin palabras,<br>como quien descubre por fin<br>el punto exacto donde empieza lo infinito." },
  { start: 30, end: 35, text: "Ya est√°s llegando, bienvenida", final: true }
];

let currentNarrativeIndex = -1;
let narrativeInterval;
let galaxyInitialized = false;

function syncNarrativeWithMusic() {
  const currentTime = backgroundMusic.currentTime;
  
  // Encontrar qu√© texto deber√≠a mostrarse basado en el tiempo actual
  let shouldShowIndex = -1;
  for (let i = 0; i < narrativeTimeline.length; i++) {
    if (currentTime >= narrativeTimeline[i].start && currentTime < narrativeTimeline[i].end) {
      shouldShowIndex = i;
      break;
    }
  }
  
  // Si no hay texto que mostrar, ocultar
  if (shouldShowIndex === -1) {
    if (currentNarrativeIndex !== -1) {
      currentNarrative.classList.remove('visible');
      currentNarrativeIndex = -1;
    }
  } else {
    // Si es un texto nuevo, mostrarlo
    if (shouldShowIndex !== currentNarrativeIndex) {
      currentNarrativeIndex = shouldShowIndex;
      const narrative = narrativeTimeline[currentNarrativeIndex];
      
      currentNarrative.innerHTML = narrative.text;
      
      if (narrative.final) {
        currentNarrative.classList.add('final');
      } else {
        currentNarrative.classList.remove('final');
      }
      
      // Forzar reflow para animaci√≥n
      currentNarrative.offsetHeight;
      currentNarrative.classList.add('visible');
    }
  }
  
  // Si llegamos al final del timeline, preparar para mostrar la galaxia
  if (currentTime >= narrativeTimeline[narrativeTimeline.length - 1].end && !galaxyInitialized) {
    clearInterval(narrativeInterval);
    setTimeout(() => {
      narrativeContainer.style.display = 'none';
      currentNarrative.classList.remove('visible');
      showGalaxy();
      galaxyInitialized = true;
    }, 500);
  }
}

function createWarpEffect() {
  warpEffect.innerHTML = '';
  const lines = 50;
  
  for (let i = 0; i < lines; i++) {
    const line = document.createElement('div');
    line.className = 'warp-line';
    line.style.top = `${(i / lines) * 100}%`;
    line.style.opacity = '0';
    warpEffect.appendChild(line);
  }
  
  return warpEffect.querySelectorAll('.warp-line');
}

function startWarpTransition() {
  // 1. Ocultar pantalla de bienvenida
  welcomeScreen.style.display = 'none';
  
  // 2. Iniciar m√∫sica INMEDIATAMENTE
  backgroundMusic.currentTime = 0;
  backgroundMusic.play().catch(e => {
    console.log('Audio playback failed:', e);
    const err = document.getElementById('err');
    err.textContent = 'Para escuchar la m√∫sica, haz clic en cualquier parte de la pantalla.';
    err.style.display = 'block';
    
    const playOnClick = () => {
      backgroundMusic.play().then(() => {
        err.style.display = 'none';
        document.removeEventListener('click', playOnClick);
      });
    };
    document.addEventListener('click', playOnClick);
  });
  
  // 3. Mostrar efecto warp Y narrativa SIMULT√ÅNEAMENTE
  warpEffect.style.display = 'block';
  narrativeContainer.style.display = 'flex';
  
  // Iniciar sistema de sincronizaci√≥n
  narrativeInterval = setInterval(syncNarrativeWithMusic, 100);
  
  // Efecto warp (m√°s r√°pido)
  const lines = warpEffect.querySelectorAll('.warp-line');
  let completed = 0;
  
  lines.forEach((line, index) => {
    setTimeout(() => {
      line.style.opacity = '1';
      line.animate([
        { transform: 'scaleX(0.1)', opacity: 0 },
        { transform: 'scaleX(1)', opacity: 0.8 },
        { transform: 'scaleX(0.1)', opacity: 0 }
      ], {
        duration: 600,
        easing: 'cubic-bezier(0.4, 0, 0.2, 1)'
      });
      
      setTimeout(() => {
        completed++;
        if (completed === lines.length) {
          warpEffect.style.display = 'none';
        }
      }, 600);
    }, index * 20);
  });
}

function showGalaxy() {
  // Mostrar galaxia solo cuando termine la narrativa
  galaxyCanvas.style.display = 'block';
  fxCanvas.style.display = 'block';
  pill.style.display = 'block';
  
  // Inicializar la galaxia si no se ha hecho
  if (!galaxyInitialized) {
    initGalaxy();
    galaxyInitialized = true;
  }
}

enterBtn.addEventListener('click', startWarpTransition);
createWarpEffect();

// ====== GALAXY INITIALIZATION ======
const err = document.getElementById('err');
function showError(msg){ err.textContent = msg; err.style.display='block'; }

// ====== WEBGL CHECK ======
try { 
  const test = document.createElement('canvas').getContext('webgl') || document.createElement('canvas').getContext('experimental-webgl');
  if(!test) throw new Error('Tu navegador no tiene WebGL activo');
} catch(e) { showError('WebGL parece desactivado. Prueba con Chrome/Edge/Firefox, o habilita aceleraci√≥n por hardware.'); return; }

// ====== THREE.JS GALAXY ======
function initGalaxy() {
  try {
    const canvas = document.getElementById('galaxy-canvas');
    const renderer = new THREE.WebGLRenderer({ canvas, antialias:true, alpha:false });
    renderer.setPixelRatio(Math.min(2, window.devicePixelRatio||1));
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.outputEncoding = THREE.sRGBEncoding;

    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 2000);
    const controls = new THREE.OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true; controls.dampingFactor = 0.06;
    controls.minDistance = 10; controls.maxDistance = 220;
    controls.target.set(0,0,0);

    function setCam(){
      const w = window.innerWidth, h = window.innerHeight;
      const isMobile = w < 768 || w < h;
      camera.fov = isMobile ? 90 : 75;
      camera.position.set(0, isMobile? 26 : 22, isMobile? 110 : 75);
      camera.updateProjectionMatrix(); controls.update();
    } 
    setCam();

    function makePrettyStarTexture(size=1024, count=2000) {
      const c = document.createElement('canvas'); c.width = c.height = size;
      const g = c.getContext('2d');
      const r = size/2;
      const bg = g.createRadialGradient(r,r, r*0.2, r,r, r);
      bg.addColorStop(0,'#1a0014');
      bg.addColorStop(1,'#000000');
      g.fillStyle = bg; g.fillRect(0,0,size,size);

      for (let i=0;i<count;i++) {
        const x = Math.random()*size, y = Math.random()*size;
        const base = Math.random()*0.7 + 0.3;
        const glow = g.createRadialGradient(x,y,0, x,y, Math.random()*2.2+1.6);
        const huePick = Math.random();
        let colInner = 'rgba(255,255,255,'+(0.65*base)+')';
        let colOuter = 'rgba(255,182,193,'+(0.15*base)+')';
        if (huePick < 0.25) { colOuter = 'rgba(255,150,200,'+(0.15*base)+')'; }
        if (huePick < 0.1) { colOuter = 'rgba(255,200,220,'+(0.15*base)+')'; }
        glow.addColorStop(0, colInner);
        glow.addColorStop(1, colOuter);
        g.fillStyle = glow; g.beginPath(); g.arc(x,y, Math.random()*1.2+0.6, 0, Math.PI*2); g.fill();
      }
      return new THREE.CanvasTexture(c);
    }

    const bgGeo = new THREE.SphereGeometry(600, 64, 64);
    const starTex = makePrettyStarTexture(1024, 2600);
    starTex.wrapS = starTex.wrapT = THREE.RepeatWrapping;
    const bg = new THREE.Mesh(bgGeo, new THREE.MeshBasicMaterial({ map: starTex, side: THREE.BackSide, transparent:false, opacity:0.85 }));
    scene.add(bg);

    const galaxy = new THREE.Group(); scene.add(galaxy);
    const phrases = [
      "Me gusta c√≥mo tu sonrisa ilumina mi d√≠a.", "Me gusta c√≥mo me haces sentir √∫nico.", "Me gusta que nuestros corazones coincidan.", "Me gusta que me digas amor.", "Me gusta tu sonrisa.", "Me gusta que me gustes.", "Me gusta c√≥mo te enojas.", "Me gustan tus besos suaves.", "Me gusta c√≥mo me amas.", "Me gusta que est√©s para m√≠.",
      "Me gusta que digas que me extra√±as.", "Me gusta que digas cu√°nto te gusto.", "Me gusta tu humildad.", "Me gusta c√≥mo me haces sentir especial.", "Me gusta c√≥mo brillan tus ojos al sonre√≠r.", "Me gusta c√≥mo tu risa ilumina todo.", "Me gustan tus manos entrelazadas con las m√≠as.", "Me gusta tu forma de cuidar a otros.", "Me gusta c√≥mo una mirada tuya me basta.", "Me gusta la calma que encuentro contigo.",
      "Me gusta tu esfuerzo por ser mejor.", "Me gusta nuestra conexi√≥n profunda.", "Me gusta c√≥mo llenas mi vida de amor.", "Me gusta tu honestidad y autenticidad.", "Me gusta la seguridad de tus brazos.", "Me gusta que vuelvas especial cada d√≠a.", "Me gusta la tranquilidad a tu lado.", "Me gusta c√≥mo me haces re√≠r.", "Me gusta tu amor incondicional.", "Me gusta c√≥mo haces cada momento √∫nico.",
      "Me gusta la paz en tu mirada.", "Me gusta sentirme amado con tus gestos.", "Me gusta nuestra conexi√≥n.", "Me gusta tu forma de caminar.", "Me gusta verte feliz conmigo.", "Me gusta que me quieras solo a m√≠.", "Me gusta todo de ti.", "Me gusta decirte te amo.", "Me gustan tus labios dulces.", "Me gusta tu aroma.",
      "Me gusta caminar contigo.", "Me gusta ser tu amor.", "Me gusta c√≥mo me miras.", "Me gustan tus abrazos.", "Me gusta c√≥mo dices mi nombre.", "Me gustan tus besos √∫nicos.", "Me gusta que no puedas enojarte conmigo.", "Me gusta que siempre me mejores el √°nimo.", "Me gusta causarte escalofr√≠os.", "Me gusta c√≥mo te preocupas por m√≠.",
      "Me gusta tu confianza en m√≠.", "Me gusta c√≥mo te desesperas.", "Me gusta tu sonrisa.", "Me gusta o√≠rte cantar.", "Me gusta c√≥mo me haces sentir √∫nico.", "Me gusta c√≥mo llegaste a mi vida.", "Me gusta tu paciencia.", "Me gusta que me entiendas sin palabras.", "Me gusta tu apoyo.", "Me gusta c√≥mo me cuidas.",
      "Me gusta tu ternura.", "Me gusta c√≥mo aceleras mi coraz√≥n.", "Me gusta que cada momento contigo sea un sue√±o.", "Me gusta c√≥mo me haces sentir especial.", "Me gusta c√≥mo nuestras risas encajan.", "Me gusta que nuestros corazones coincidan.", "Me gusta tu amor de cada d√≠a.", "Me gusta c√≥mo nuestras almas conectan.", "Me gustan los detalles que compartimos.", "Me gusta que me ames aun en d√≠as dif√≠ciles.",
      "Me gusta c√≥mo nuestras miradas hablan.", "Me gusta imaginar un futuro contigo.", "Me gusta que me inspires a ser mejor.", "Me gusta c√≥mo me haces sentir seguro.", "Me gustan tus mensajes diarios.", "Me gusta que hayas llegado a mi vida.", "Me gusta c√≥mo nuestras sonrisas se reflejan.", "Me gusta c√≥mo nuestro amor brilla incluso en lo oscuro.", "Me gustan tus caricias.", "Me gusta sentirme seguro en tus abrazos.",
      "Me gusta tu apoyo constante.", "Me gusta que me hagas creer en el amor.", "Me gusta c√≥mo enciendes mi amor por ti.", "Me gusta c√≥mo vuelves lo simple extraordinario.", "Me gusta ser tu motivo de sonrisa.", "Me gusta imaginar un futuro juntos.", "Me gusta c√≥mo me besas.", "Me gusta que tus besos me eleven.", "Me gusta c√≥mo dices te amo.", "Me gusta que me aceptes con mis defectos.",
      "Me gustan tus abrazos cuando estoy triste.", "Me gusta tu amor diario.", "Me gusta c√≥mo me miras.", "Me gusta c√≥mo tus actos dicen que me amas.", "Me gusta c√≥mo me haces creer en la magia.", "Me gusta la calidez de tus besos y abrazos.", "Me gusta que seas mi sue√±o inesperado.", "Me gusta vivir cada segundo contigo.", "Me gusta ser tu amor.", "Me gusta amarte como t√∫ me amas."
    ];
    const phraseCount = Math.max(phrases.length * 2, 200);
    const arms = 5, radius = 82, maxH = 22;

    function makeTextTexture(text, size=36){
      const c=document.createElement('canvas'); c.width=1024; c.height=128;
      const g=c.getContext('2d'); g.clearRect(0,0,c.width,c.height);
      g.font='600 '+size+'px -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial';
      g.textAlign='center'; g.textBaseline='middle';
      g.shadowColor='rgba(255,150,200,0.95)'; g.shadowBlur=24;
      g.fillStyle='rgba(255,240,245,0.98)'; g.fillText(text,c.width/2,c.height/2);
      return new THREE.CanvasTexture(c);
    }

    for(let i=0;i<phraseCount;i++){ 
      const text = phrases[i%phrases.length];
      const tex=makeTextTexture(text,36);
      const spr=new THREE.Sprite(new THREE.SpriteMaterial({ map:tex, transparent:true, depthWrite:false }));
      spr.isPhrase=true;
      const perArm=phraseCount/arms; 
      const ang=(i%perArm)*(Math.PI*2/perArm);
      const armAng=Math.floor(i/perArm)*(Math.PI*2/arms);
      const dist=Math.pow(i/phraseCount,0.72)*radius;
      const thickness=Math.pow(1-(dist/radius),2);
      const x=Math.cos(ang+armAng)*dist, z=Math.sin(ang+armAng)*dist, y=(Math.random()-0.5)*maxH*thickness*.9;
      spr.position.set(x,y,z); spr.scale.set(20,2.6,1); galaxy.add(spr);
    }

    const starCount=8000, geom=new THREE.BufferGeometry(), pos=new Float32Array(starCount*3);
    for(let i=0;i<starCount;i++){ 
      const ang=Math.random()*Math.PI*2, dist=Math.random()*radius*1.15;
      const y=(Math.random()-0.5)*36*Math.pow(1-Math.min(dist,radius)/radius,1.5);
      pos[i*3]=Math.cos(ang)*dist; pos[i*3+1]=y; pos[i*3+2]=Math.sin(ang)*dist; 
    }
    geom.setAttribute('position', new THREE.BufferAttribute(pos,3));
    galaxy.add(new THREE.Points(geom, new THREE.PointsMaterial({ color:0xffb6c1, size:0.28, transparent:true, opacity:0.65, blending:THREE.AdditiveBlending })));

    const coreR=12;
    const coreTexCanvas=document.createElement('canvas'); coreTexCanvas.width=coreTexCanvas.height=256;
    const cg=coreTexCanvas.getContext('2d'); const grd=cg.createRadialGradient(128,128,10,128,128,128);
    grd.addColorStop(0,'#1a0014'); grd.addColorStop(0.6,'#0f000a'); grd.addColorStop(1,'#000'); cg.fillStyle=grd; cg.arc(128,128,128,0,Math.PI*2); cg.fill();
    const core=new THREE.Mesh(new THREE.SphereGeometry(coreR,64,64), new THREE.MeshBasicMaterial({ map:new THREE.CanvasTexture(coreTexCanvas) }));
    core.renderOrder=1; scene.add(core);

    const photonRing=new THREE.Mesh(new THREE.RingGeometry(coreR*1.05, coreR*1.18, 128), new THREE.MeshBasicMaterial({ color:0xFFB6C1, transparent:true, opacity:0.95, side:THREE.DoubleSide }));
    photonRing.rotation.x=-Math.PI/2; photonRing.renderOrder=0.5; scene.add(photonRing);

    function makeHaloTexture(size=1024, inner=0.45){
      const c=document.createElement('canvas'); c.width=c.height=size; const g=c.getContext('2d'); const r=size/2;
      const grd=g.createRadialGradient(r,r,r*inner, r,r,r);
      grd.addColorStop(0.0,'rgba(255,182,193,0.45)');
      grd.addColorStop(0.35,'rgba(255,150,180,0.35)');
      grd.addColorStop(0.7,'rgba(255,200,220,0.28)');
      grd.addColorStop(1,'rgba(0,0,0,0)');
      g.fillStyle=grd; g.fillRect(0,0,size,size); const tex=new THREE.CanvasTexture(c); tex.needsUpdate=true; return tex;
    }
    const haloPlane=new THREE.Mesh(new THREE.PlaneGeometry(320,320), new THREE.MeshBasicMaterial({ map:makeHaloTexture(1024,0.45), transparent:true, depthWrite:false, blending:THREE.AdditiveBlending, opacity:0.9 }));
    haloPlane.rotation.x=-Math.PI/2; haloPlane.renderOrder=0.2; scene.add(haloPlane);

    let tw = 0;
    function animate(){
      requestAnimationFrame(animate);
      const t = performance.now()*0.001;
      tw = (tw + 0.0003) % 1;
      starTex.offset.set(tw, 0);
      galaxy.rotation.y = t * 0.05;
      core.rotation.y = t * 0.12;
      photonRing.rotation.z = t * 0.18;
      haloPlane.rotation.z = t * 0.02;
      controls.update();
      renderer.render(scene, camera);
    } 
    animate();

    // ====== HEARTS OVERLAY ======
    const fx = document.getElementById('fx');
    const ctx2 = fx.getContext('2d');
    function resizeFx(){
      fx.width = Math.floor(innerWidth * Math.min(2, window.devicePixelRatio||1));
      fx.height = Math.floor(innerHeight * Math.min(2, window.devicePixelRatio||1));
      fx.style.width = innerWidth + 'px';
      fx.style.height = innerHeight + 'px';
    }
    addEventListener('resize', resizeFx); 
    resizeFx();
    
    const DPR = Math.min(2, window.devicePixelRatio || 1);
    const hearts = [];
    function spawnHearts(x,y,n=20){
      x *= DPR; y *= DPR;
      for(let i=0;i<n;i++){ 
        const a=Math.random()*Math.PI*2;
        hearts.push({x,y,vx:Math.cos(a)*(0.6+Math.random()*0.8),vy:-(0.8+Math.random()*1.2),life:1,size:10+Math.random()*16});
      }
    }
    
    function drawHeart(x,y,size){
      const s=size; ctx2.save(); ctx2.translate(x,y);
      ctx2.beginPath(); ctx2.moveTo(0,-0.25*s);
      ctx2.bezierCurveTo(.5*s,-.9*s,1.4*s,-.1*s,0,.9*s);
      ctx2.bezierCurveTo(-1.4*s,-.1*s,-.5*s,-.9*s,0,-.25*s);
      const g=ctx2.createRadialGradient(0,0,0,0,0,s);
      g.addColorStop(0,'rgba(255,182,193,.95)'); g.addColorStop(1,'rgba(255,105,180,0)');
      ctx2.fillStyle=g; ctx2.fill(); ctx2.restore();
    }
    
    let lastTap=0;
    addEventListener('click', (e)=>{ 
      const now=performance.now(); 
      if(now-lastTap<320) spawnHearts(e.clientX,e.clientY,20); 
      lastTap=now; 
    }, {passive:true});
    
    addEventListener('touchend', (e)=>{ 
      const now=performance.now(); 
      const t=e.changedTouches&&e.changedTouches[0]; 
      if(now-lastTap<320&&t) spawnHearts(t.clientX,t.clientY,20); 
      lastTap=now; 
    }, {passive:true});

    function loopFx(){
      ctx2.clearRect(0,0,fx.width,fx.height);
      for(let i=hearts.length-1;i>=0;i--){ 
        const h=hearts[i]; 
        h.x+=h.vx; h.y+=h.vy; h.vy-=0.02; h.life-=0.015;
        ctx2.globalAlpha=Math.max(0,h.life); 
        drawHeart(h.x,h.y,h.size); 
        ctx2.globalAlpha=1; 
        if(h.life<=0) hearts.splice(i,1);
      }
      requestAnimationFrame(loopFx);
    } 
    loopFx();

  } catch(e) { 
    showError('Error cargando la galaxia: '+e.message); 
    console.error(e); 
  }
}

window.addEventListener('resize', function() {
  if (typeof setCam === 'function') setCam();
  if (typeof resizeFx === 'function') resizeFx();
});
})();
</script>
</body>
</html>